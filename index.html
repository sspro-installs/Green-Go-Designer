if (!State.projectDetails.configName || !State.projectDetails.userName) {
            showAlert('Please enter Project Name and Designer Name in Step 2 before printing.', 'warning');
            State.step = 2;
            renderApp();
            return;
        }
        State.isPrinting = true;
        renderApp();
        setTimeout(() => {
            window.print();
            State.isPrinting = false;
        }, 100);
      }
    }

    function handleLocationModalEvents(e) {
      if (!State.isLocationModalOpen) return;

      const target = e.target.closest('[data-loc-action]');
      if (target) {
        const action = target.dataset.locAction;
        const id = target.dataset.id;
        const span = byId(id);
        if (!span) return;

        let val = parseInt(span.innerText, 10);
        if (action === 'inc-qty') val++;
        if (action === 'dec-qty') val = Math.max(0, val - 1);
        span.innerText = val;

        setupLocationModalFieldReactivity();
        return;
      }

      if (e.target.id === 'loc-existing-headsets' || e.target.id === 'loc-hd') {
        setupLocationModalFieldReactivity();
      }
    }

    function setupLocationModalFieldReactivity() {
        if (!State.isLocationModalOpen) return;

        const keyPanelCountEl = byId('loc-keypanelcount');
        const wirelessCountEl = byId('loc-wireless');
        const wiredCountEl = byId('loc-wired');
        const wallStationCountEl = byId('loc-wallstation');
        const hStd1El = byId('h-std1');
        const hStd2El = byId('h-std2');
        const hComf1El = byId('h-comf1');
        const hComf2El = byId('h-comf2');
        const hHandsetEl = byId('h-handset');
        const isCustomerSuppliedEl = byId('loc-existing-headsets');
        const mountWrapEl = byId('loc-mount-wrap');
        const hdWrapEl = byId('loc-hd-wrap');
        const headsetTotalEl = byId('loc-headset-total');
        const remainingEl = byId('loc-headset-remaining');
        const warningEl = byId('loc-headset-warning');
        const customerSuppliedWrapEl = byId('loc-customer-supplied-wrap');

        const keyPanelCount = keyPanelCountEl ? parseInt(keyPanelCountEl.innerText, 10) : 0;
        const wirelessCount = wirelessCountEl ? parseInt(wirelessCountEl.innerText, 10) : 0;
        const wired = wiredCountEl ? parseInt(wiredCountEl.innerText, 10) : 0;
        const wall = wallStationCountEl ? parseInt(wallStationCountEl.innerText, 10) : 0;

        const h_std1 = hStd1El ? parseInt(hStd1El.innerText, 10) : 0;
        const h_std2 = hStd2El ? parseInt(hStd2El.innerText, 10) : 0;
        const h_comf1 = hComf1El ? parseInt(hComf1El.innerText, 10) : 0;
        const h_comf2 = hComf2El ? parseInt(hComf2El.innerText, 10) : 0;
        const h_handset = hHandsetEl ? parseInt(hHandsetEl.innerText, 10) : 0;

        const isCustomerSupplied = isCustomerSuppliedEl ? isCustomerSuppliedEl.checked : false;

        if(mountWrapEl) mountWrapEl.style.visibility = keyPanelCount > 0 ? 'visible' : 'hidden';

        if(hdWrapEl) hdWrapEl.style.display = wirelessCount > 0 ? 'flex' : 'none';

        const totalDevices = keyPanelCount + wirelessCount + wired + wall;
        const totalHeadsetsAllocated = h_std1 + h_std2 + h_comf1 + h_comf2 + h_handset;
        const remaining = totalDevices - totalHeadsetsAllocated;

        if(headsetTotalEl) headsetTotalEl.innerText = `(${totalHeadsetsAllocated} of ${totalDevices} devices)`;

        if (remaining > 0) {
            if(remainingEl) {
                remainingEl.innerText = `Remaining: ${remaining}`;
                remainingEl.style.color = '#f87171';
            }
            if(warningEl) warningEl.style.display = isCustomerSupplied ? 'none' : 'block';
        } else if (remaining < 0) {
            if(remainingEl) {
                remainingEl.innerText = `Over-allocated: ${Math.abs(remaining)}`;
                remainingEl.style.color = '#facc15';
            }
           if(warningEl) warningEl.style.display = 'none';
        } else {
            if(remainingEl) {
                remainingEl.innerText = 'All devices allocated';
                remainingEl.style.color = '#4ade80';
            }
           if(warningEl) warningEl.style.display = 'none';
        }

        if(customerSuppliedWrapEl) {
            customerSuppliedWrapEl.style.display = totalDevices > 0 ? 'flex' : 'none';
            if (totalDevices === 0 && isCustomerSuppliedEl) {
               isCustomerSuppliedEl.checked = false;
               if(warningEl && remaining > 0) warningEl.style.display = 'block';
            }
        }
    }

    function handleProjectDetailsInput(e) {
      if (State.step !== 2) return;
      const { id, value } = e.target;
      if (id === 'configName') State.projectDetails.configName = value;
      if (id === 'userName') State.projectDetails.userName = value;

      const btn = byId('start-step2-btn');
      if (btn) {
        if (State.projectDetails.configName && State.projectDetails.userName) {
          btn.disabled = false;
          btn.classList.remove('bg-gray-500', 'cursor-not-allowed');
          btn.classList.add('btn-primary', 'hover:bg-green-700');
        } else {
          btn.disabled = true;
          btn.classList.add('bg-gray-500', 'cursor-not-allowed');
          btn.classList.remove('btn-primary', 'hover:bg-green-700');
        }
      }
    }

    function handleInfrastructureInput(e) {
      if (State.step !== 4) return;
      const target = e.target.closest('[data-inf-field]');
      if (!target) return;

      const fieldName = target.dataset.infField;

      if (target.type === 'checkbox') {
        State.infrastructureDetails[fieldName] = target.checked;
      } else if (target.type === 'radio') {
        State.infrastructureDetails[fieldName] = target.value;
      }

      if (fieldName === 'farDistance' && target.value === 'no') {
        State.infrastructureDetails.wirelessAtFar = false;
        State.infrastructureDetails.wiredAtFar = false;
      }

      State.isFinalEditMode = false;
      renderApp();
    }

    function byId(id) { return document.getElementById(id); }
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
           .replace(/&/g, '&amp;')
           .replace(/</g, '&lt;')
           .replace(/>/g, '&gt;')
           .replace(/"/g, '&quot;')
           .replace(/'/g, '&#039;');
    }
    function showAlert(message, type = 'info', onConfirm = null, onCancel = null) {
      State.systemAlert = { show: true, message, type, onConfirm, onCancel };
      renderApp();
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderApp();

      const debouncedProjectInput = debounce(handleProjectDetailsInput, 200);

      document.body.addEventListener('click', e => {
        handleGlobalClick(e);
        handleLocationModalEvents(e);
      });

      document.body.addEventListener('input', e => {
        if (State.step === 2 && (e.target.id === 'configName' || e.target.id === 'userName')) {
           debouncedProjectInput(e);
        }
        if (State.step === 4 && e.target.closest('[data-inf-field]')) {
           handleInfrastructureInput(e);
        }
        if (State.isLocationModalOpen && (e.target.id === 'loc-existing-headsets' || e.target.id === 'loc-hd')) {
           setupLocationModalFieldReactivity();
        }
      });
    });
  })();
  </script>
</body>
</html>
